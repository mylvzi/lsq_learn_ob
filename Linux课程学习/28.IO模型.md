# å‰è¨€: æ·±åˆ»ç†è§£IO
>è¿›ç¨‹é—´é€šä¿¡çš„æœ¬è´¨ -->`IO`
>`I` : Input
>`O` : Output

ç«™åœ¨è¿›ç¨‹çš„è§’åº¦ :
* input : ä»OSä¸­è·å–æ•°æ®(è¾“å…¥ç¼“å†²åŒº)
* output : å°†æ•°æ®å†™å…¥åˆ°OS(è¾“å‡ºç¼“å†²åŒº)

åŒæ—¶, OSä¹Ÿæ˜¯ä¸€ä¸ªè¿›ç¨‹, ä¹Ÿå­˜åœ¨äºå†…å­˜ä¹‹ä¸­, æ‰€ä»¥, IOçš„æœ¬è´¨å°±æ˜¯: `å†…å­˜å’Œå¤–è®¾ä¹‹é—´çš„äº¤äº’`
ä»¥ç½‘ç»œé€šä¿¡ä¸ºä¾‹, input : ä»è¾“å…¥ç¼“å†²åŒº(ç½‘å¡)ä¸­è¯»å–æ•°æ®, output, å°†æ•°æ®å†™å…¥åˆ°è¾“å‡ºç¼“å†²åŒº, ç­‰å¾…åˆé€‚çš„æ—¶æœºç”±OSå†™å…¥åˆ°ç½‘å¡
![[Pasted image 20260203231748.png]]
# ä¸€.IOåˆ°åº•æ˜¯ä»€ä¹ˆ
`IO = ç­‰å¾… + æ‹·è´`
* ç­‰å¾… : ç­‰å¾…äº‹ä»¶å°±ç»ª/ç­‰å¾…èµ„æºå°±ç»ª, æ¯”å¦‚é”®ç›˜ç¼“å†²åŒºä¸­è¦æœ‰æ•°æ®, å¦åˆ™å°±ä¼šé˜»å¡ç­‰å¾…
* æ‹·è´ : ä¸€æ—¦èµ„æºå°±ç»ª, ç›´æ¥æ‰§è¡Œæ•°æ®çš„æ‹·è´(è¾“å…¥ç¼“å†²åŒº --> å†…æ ¸)

`é«˜æ•ˆIOæ˜¯ä»€ä¹ˆ`
å³IOçš„æ•ˆç‡æœ€é«˜, IO = ç­‰å¾… + æ‹·è´, æ‹·è´æ“ä½œä¸€èˆ¬æ˜¯ç”±ç¼“å†²åŒº-->å†…æ ¸/ç¼“å†²åŒº-->å¤–è®¾, æ‹·è´çš„é€Ÿåº¦å–å†³äºç¡¬ä»¶, è¿™é‡Œæˆ‘ä»¬å‡è®¾æ˜¯åœ¨åŒä¸€ç¡¬ä»¶è®¾å¤‡æ¡ä»¶ä¸‹

æ‰€ä»¥,IOæ•ˆç‡çš„ç“¶é¢ˆåœ¨äº`ç­‰å¾…`, ä¾æ®ç­‰å¾…æ–¹å¼çš„ä¸åŒ, åˆ†ä¸ºä¸åŒçš„IOæ¨¡å‹

# äºŒ.å¸¸è§çš„IOæ¨¡å‹
```css
é˜»å¡IO --> æœ€å¸¸è§  èµ„æºä¸å°±ç»ªå°±ä¸€ç›´ç­‰
éé˜»å¡IO --> fcntl  è½®è®­ç­‰å¾…
ä¿¡å·é©±åŠ¨IO --> é€šè¿‡ä¿¡å·æœºåˆ¶å®ç°ç­‰å¾…
å¤šè·¯å¤ç”¨IO --> å¤šä¸ªé±¼ç«¿/æ•ˆç‡æœ€é«˜çš„ç­‰å¾…æ–¹å¼
å¼‚æ­¥IO --> å‘èµ·IO/å¤„ç†IOè§£è€¦
```

`åŒæ­¥ vs å¼‚æ­¥`
* åŒæ­¥ : å‚ä¸IO
* å¼‚æ­¥ : ä¸å‚ä¸IO

å¯¹äºä¿¡å·é©±åŠ¨IO, è¿›ç¨‹æœ¬è´¨ä¸Šå‚ä¸äº†ç­‰å¾…IOçš„è¿‡ç¨‹, åªæ˜¯ç­‰å¾…çš„æœºåˆ¶æ˜¯é€šè¿‡ä¿¡å·è¿™ç§`å¼‚æ­¥æœºåˆ¶`, ä½†ä¸å½±å“æ˜¯åŒæ­¥IO

`é˜»å¡ vs éé˜»å¡`
* é˜»å¡ : èµ„æºä¸å°±ç»ªå°±ä¸€ç›´ç­‰å¾…
* éé˜»å¡ : èµ„æºä¸å°±ç»ª, è½®è®­æŸ¥çœ‹æ˜¯å¦å°±ç»ª; ä¸¤æ¬¡è½®è®­æœŸé—´, å¯ä»¥ do other thing

# ä¸‰.éé˜»å¡IO
```bash
NAME
       fcntl - manipulate file descriptor  æ“çºµæ–‡ä»¶æè¿°ç¬¦, æ›´æ”¹fdå¯¹åº”çš„struct fileå±æ€§

SYNOPSIS
       #include <unistd.h>
       #include <fcntl.h>

       int fcntl(int fd, int cmd, ... /* arg */ );
       
       fcntl()  performs  one of the operations described below on the open file descriptor fd.  The operation is deâ€
       termined by cmd.
```

æœ€å¸¸è§çš„æ“ä½œ: å°†fdå¯¹åº”çš„struct fileæ›´æ”¹ä¸ºéé˜»å¡
```c++
  6 {
  7     // 1.å…ˆè·å¾—å¯¹åº”fdçš„flag
  8     int flag = fcntl(0, F_GETFL);
  9     if(flag < 0)
 10     {
 11         perror("F_GETFL");
 12         return 1;
 13     }   
 14     
 15     // 2.æ›´æ”¹ä¸ºéé˜»å¡çŠ¶æ€
 16     int flag2 = fcntl(0, F_SETFL, flag | O_NONBLOCK);
 17     if(flag2 < 0)
 18     {
 19         perror("F_SETFL");
 20         return 1;
 21     }   
 22     
 23     char buf[128];
 24     while(true)
 25     {
 26         ssize_t n = read(0, buf, sizeof(buf));
 27         if(n > 0) 
 28         {
 29             std::cout << "i am read data" << std::endl;
 30         }   
 31         else if(n == -1 && errno == E_AGAIN)
 32         {
 33             std::cout << "no data! but i am alive" << std::endl;
 34         }   
 35         
 36         sleep(1);
 37     }   
 38 }                                                                                                                   
```

![[Pasted image 20260205222539.png]]
`n == -1 && errno == EAGAIN`
errnoæ˜¯ä¸€ä¸ªçº¿ç¨‹çš„å±€éƒ¨å˜é‡, å½“çº¿ç¨‹æ‰§è¡Œå¤±è´¥, é”™è¯¯ç è¿”å›-1, å…³äºæ­¤æ¬¡æ‰§è¡Œé”™è¯¯çš„åŸå› å°±ä¼šè¢«å†™å…¥errnoè¿™ä¸ªå±€éƒ¨å˜é‡é‡Œé¢

EAGAIN == EWOULDBLOCKè¡¨ç¤ºçš„å«ä¹‰ç›¸åŒ --> è¿™æ¬¡å¤±è´¥äº†, å†å°è¯•ä¸€æ¬¡ -->è¯´æ˜çº¿ç¨‹è¿˜åœ¨è¿è¡Œ, æ²¡æœ‰é˜»å¡


# å››.å¤šè·¯å¤ç”¨
>ä¸€ä¸ªsystem callåªèƒ½ç»‘å®šä¸€ä¸ªsockfd, ä¸ºäº†å®ç°å¤šè·¯å¤ç”¨, è®¾è®¡äº†ä¸€äº›system call, æ”¯æŒç»‘å®šå¤šä¸ªsockfd

å¤šè·¯å¤ç”¨ä¹Ÿæ˜¯ä¸€ç§IOæœºåˆ¶, ä¹Ÿéµå¾ª`IO = ç­‰ + æ‹·è´`, æ‹·è´çš„å‰ææ˜¯äº‹ä»¶å°±ç»ª:
1. OSåº•å±‚æœ‰æ•°æ® --> è¯»ç«¯å°±ç»ª
2. OSåº•å±‚æœ‰ç©ºé—´ --> å†™ç«¯å°±ç»ª

å¤šè·¯å¤ç”¨çš„**ç­‰**æŒ‡çš„æ˜¯:
* ç»‘å®šå¤šä¸ªfd, ç­‰å¾…æ¯ä¸€ä¸ªfdä¸Šçš„äº‹ä»¶æ˜¯å¦å°±ç»ª, ä¸€æ—¦å°±ç»ª, å°±ç«‹å³é€šçŸ¥å¼€å§‹IO

selectå°±æ˜¯IOå¤šè·¯å¤ç”¨çš„å®ç°æ–¹å¼ä¹‹ä¸€

## 1.select
### 1.ä½œç”¨å’Œå®šä½
å®šä½: åªè´Ÿè´£ç­‰å¾…
ä½œç”¨: ç­‰å¾…å¤šä¸ªfd,ç­‰å¾…fdä¸Šé¢çš„äº‹ä»¶å°±ç»ª, å°±å»é€šçŸ¥ç¨‹åºå‘˜, è¿‡æ¥å¤„ç†, å¯ä»¥è¿›è¡ŒIOæ‹·è´
### 2.selectæ¥å£
```c
int select(
    int nfds, // æœ€å¤§fd + 1
    fd_set *readfds, // å…³å¿ƒå¯è¯»?
    fd_set *writefds, // å…³å¿ƒå¯å†™?
    fd_set *exceptfds, // å…³å¿ƒå¼‚å¸¸?
    struct timeval *timeout // æ—¶é—´é—´éš”
);
```
è¿”å›å€¼ï¼š
- `> 0`ï¼š**æœ‰å¤šå°‘ä¸ª fd å°±ç»ª**
- `= 0`ï¼š**è¶…æ—¶**
- `-1`ï¼šå‡ºé”™ï¼ˆerrno)
`fd_set` : æ˜¯ä¸€ä¸ªä½å›¾
* ä½ç½®: ç¬¬å‡ ä¸ªfd
* å†…å®¹: 0 è¡¨ç¤ºä¸å…³å¿ƒæ­¤fd  1è¡¨ç¤ºå…³å¿ƒæ­¤fd

å¸¸ç”¨å®
```c
FD_ZERO(&set);        // æ¸…ç©º
FD_SET(fd, &set);    // åŠ å…¥ fd
FD_CLR(fd, &set);    // ç§»é™¤ fd
FD_ISSET(fd, &set);  // åˆ¤æ–­ fd æ˜¯å¦å°±ç»ª
```
ä»£ç 
```c++
#include <stdio.h>
  2 #include <unistd.h>
  3 #include <sys/select.h>
  4 #include <string.h>
  5 #include <iostream>
  6 
  7 int main()
  8 {
  9     fd_set readfds;
 10     struct timeval timeout;
 11 
 12     while(1)
 13     {
 14         // selectä¼šä¿®æ”¹fd_set, æ‰€ä»¥æ¯æ¬¡è°ƒç”¨éƒ½è¦é‡æ–°FD_SET
			FD_ZERO(&readfds); // æ¸…ç©ºfd_set
 15         FD_SET(0, &readfds); // ç›‘å¬stdin fd = 0
 16 
 17         timeout.tv_sec = 5;
 18         timeout.tv_usec = 5;
 19 
 20         int ret = select(
 21             1,
 22             &readfds,
 23             NULL,                                                                                                                                    
 24             NULL,
 25             &timeout
 26         );
 27 
 28         if(ret == -1)
 29         {
 30             perror("select");
 31             break;
 32         }
 33         else if(ret == 0)
 34         {
 35             // æ—¶é—´åˆ°äº†, ä¸åº”è¯¥åœæ­¢, å› ä¸ºæ˜¯ä¸€ç›´ç›‘å¬
 std::cout << "time out" << std::endl;
 37         }
 38         else
 39         {
 40             // stdinå°±ç»ª
 41             if(FD_ISSET(0, &readfds))
 42             {
 43                 char buf[128];
 44                 int n = read(0, buf, sizeof(buf));
 45                 buf[n] = '\0';
 46                 std::cout << "read: " << buf << std::endl;
 47             }
 48         }
 49         
 50     }
 51 }                    
```
æ‰§è¡Œç»“æœ:
![[Pasted image 20260207183722.png]]

ä¸€ä¸ªè¿›ç¨‹å¾€å¾€åŒæ—¶æŒæœ‰å¤šä¸ª fdã€‚  
åœ¨ä¼ ç»Ÿé˜»å¡ IO æ¨¡å‹ä¸‹ï¼Œå¦‚æœè¿›ç¨‹å¯¹æŸä¸ª fd è°ƒç”¨é˜»å¡å¼ `read`ï¼Œè€Œè¯¥ fd å°šæœªå°±ç»ªï¼Œ**æ•´ä¸ªè¿›ç¨‹éƒ½ä¼šè¢«é˜»å¡**ï¼Œæ— æ³•å¤„ç†å…¶ä»– fdã€‚

å¼•å…¥ `select` ä¹‹åï¼Œè¿›ç¨‹ä¸å†ç›²ç›®åœ°é˜»å¡åœ¨æŸä¸€æ¬¡ `read` ä¸Šï¼Œè€Œæ˜¯**å…ˆé˜»å¡åœ¨ `select` ä¸Šï¼Œç­‰å¾…â€œä»»æ„ fd å°±ç»ªâ€çš„äº‹ä»¶å‘ç”Ÿ**ã€‚

æœ¬è´¨ä¸Šï¼Œè¿™æ˜¯å°†  
**â€œé˜»å¡åœ¨å…·ä½“ IO æ“ä½œä¸Šâ€ â†’ â€œé˜»å¡åœ¨äº‹ä»¶é€šçŸ¥æœºåˆ¶ä¸Šâ€**ï¼Œ  
ä»è€Œä½¿è¿›ç¨‹å¯ä»¥é«˜æ•ˆåœ°ç®¡ç†å¤šä¸ª fdã€‚

æ¯”å¦‚fd1å› ä¸ºè°ƒç”¨é˜»å¡å¼readå¯¼è‡´æ•´ä¸ªè¿›ç¨‹é˜»å¡, å¿…é¡»ç­‰å¾…fd1ä¸Šçš„èµ„æºå°±ç»ª, æ•´ä¸ªè¿›ç¨‹æ‰ä¼šæ¢å¤è¿è¡Œ,åœ¨è¿™æœŸé—´å°±ç®—fd2å°±ç»ª, è¿›ç¨‹ä¹Ÿæ— æ³•å¤„ç†, å¦‚æœå¼•å…¥select, å°±å¯ä»¥ä¼˜å…ˆå¤„ç†fd2, æé«˜æ•ˆç‡

ä¸€å¥è¯æ€»ç»“"
* select = IOå¤šè·¯å¤ç”¨çš„"äº‹ä»¶é€šçŸ¥å™¨"
* IOæ˜¯æŒç»­çš„, selectæ˜¯äº‹ä»¶é€šçŸ¥, æ‰€ä»¥selectå¿…é¡»æ”¾åœ¨whileé‡Œé¢

`selectçš„ç¼ºé™·`
1. å¤§å°æœ‰é™åˆ¶: åˆ©ç”¨ä½å›¾æ ‡è®°æ˜¯å¦ç›‘å¬å¯¹åº”fd, max_size = 1024, æ•°é‡æœ‰é™
2. `å½“fdè¿‡å¤šæ—¶, å¼€é”€ä¼šçº¿æ€§å¢é•¿`
	selectè°ƒç”¨çš„æµç¨‹å¯ä»¥æ€»ç»“ä¸º`ä¸¤æ¬¡å†…å­˜æ‹·è´ + ä¸€æ¬¡å…¨é‡æ‰«æ`(å†…æ ¸ä¸ä¿¡ä»»ç”¨æˆ·æ€çš„æ•°æ®!)
	```text
	ç”¨æˆ·æ€æ•°ç»„
	   â†“ copy
	å†…æ ¸æ€æ•°ç»„
	   â†“ æ‰«æ
	å†…æ ¸æ€æ•°ç»„
	   â†“ copy
	ç”¨æˆ·æ€æ•°ç»„
	```
	å†…æ ¸ä¼šä»0æ‰«æåˆ°nfd+1, å¦‚æœå°±ç»ª, å°±å°†fd_setæ›´æ–°, æ‰€ä»¥selectè¿”å›çš„è¯­ä¹‰æ˜¯: åªè¿”å›å°±ç»ªçš„fd_set
	è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ¯æ¬¡è°ƒç”¨selectéƒ½è¦æ›´æ–°çš„åŸå› 
### 3.poll
æ¥å£
```c
int poll(
    struct pollfd *fds,
    nfds_t nfds,
    int timeout
);

struct pollfd {
    int   fd;       // è¦ç›‘å¬çš„ fd
    short events;   // æˆ‘å…³å¿ƒä»€ä¹ˆäº‹ä»¶
    short revents;  // å®é™…å‘ç”Ÿäº†ä»€ä¹ˆäº‹ä»¶ï¼ˆè¿”å›ï¼‰
};

EVENTS
	POLLIN     // å¯è¯»
	POLLOUT    // å¯å†™
	POLLERR    // é”™è¯¯
	POLLHUP    // æŒ‚æ–­ï¼ˆå¯¹ç«¯å…³é—­ï¼‰

```
pollç›¸è¾ƒäºselectæœ€å¤§çš„ä¿®æ”¹å°±æ˜¯fdçš„æ ‡è®°ç”±ä½å›¾è½¬å˜ä¸ºæ•°ç»„, å¢åŠ äº†å¯ä»¥ç›‘å¬çš„æ•°é‡, ä½†æ›´æ”¹ä¸å¤§,åœ¨å¼€é”€ä¸Š, è¿˜æ˜¯éµå¾ª`ä¸¤æ¬¡å†…å­˜æ‹·è´ + ä¸€æ¬¡å…¨é‡æ‰«æ`

```c
#include <stdio.h>
#include <unistd.h>
#include <poll.h>

int main() {
    struct pollfd fds[1];

    fds[0].fd = STDIN_FILENO;   // fd = 0
    fds[0].events = POLLIN;    // å…³å¿ƒå¯è¯»

    while (1) {
        int ret = poll(fds, 1, 3000); // 3 ç§’

        if (ret < 0) {
            perror("poll");
            break;
        } else if (ret == 0) {
            printf("timeout\n");
        } else {
            if (fds[0].revents & POLLIN) {
                char buf[128];
                int n = read(STDIN_FILENO, buf, sizeof(buf));
                buf[n] = '\0';
                printf("read: %s", buf);
            }
        }
    }

    return 0;
}

```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·æ€è¿›ç¨‹   â”‚
â”‚              â”‚
â”‚ while (1) {  â”‚
â”‚   select()   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ‰« fd 0..N â”‚              â”‚
â”‚   åˆ¤æ–­å°±ç»ª   â”‚              â”‚
â”‚   read/write â”‚              â”‚
â”‚ }            â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚           å†…æ ¸             â”‚
â”‚                          â”‚
â”‚ æ¯æ¬¡ï¼š                    â”‚
â”‚  - æ‹·è´ fd é›†åˆ           â”‚
â”‚  - çº¿æ€§æ‰«ææ‰€æœ‰ fd        â”‚
â”‚  - æ‰¾å°±ç»ª fd              â”‚
â”‚  - æ‹·è´ç»“æœå›ç”¨æˆ·æ€       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- æ¯ä¸€è½® whileï¼š
    
    - éƒ½è¦â€œé—®ä¸€éæ‰€æœ‰ fdâ€
        
- æˆæœ¬ âˆ fd æ€»æ•°
    
- ä¸ç®¡æœ‰æ²¡æœ‰äº‹ä»¶ï¼Œéƒ½è¦æ‰«
### 3.epoll(é‡ç‚¹)
> **epoll çš„æœ¬è´¨ï¼š  
> ä¸æ˜¯â€œæˆ‘æ¯æ¬¡å»é—®æ‰€æœ‰ fd è°å°±ç»ªäº†â€ï¼Œ  
> è€Œæ˜¯â€œè°å°±ç»ªäº†ï¼Œå†…æ ¸ä¸»åŠ¨å‘Šè¯‰æˆ‘â€ã€‚**

è¿™æ˜¯ä» **â€œè½®è¯¢æ¨¡å‹â€ â†’ â€œäº‹ä»¶é©±åŠ¨æ¨¡å‹â€** çš„è´¨å˜ã€‚
## ğŸ”¥ epoll çš„å…³é”®å˜åŒ–åªæœ‰ä¸€æ¡

> **æŠŠâ€œå…³å¿ƒå“ªäº› fdâ€è¿™ä»¶äº‹ï¼Œä»â€œæ¯æ¬¡ç³»ç»Ÿè°ƒç”¨â€ï¼Œå˜æˆâ€œä¸€æ¬¡æ€§æ³¨å†Œâ€**
> epoll æŠŠ fd é›†åˆï¼Œä»â€œå‚æ•°â€å˜æˆäº†â€œå†…æ ¸å¯¹è±¡çš„çŠ¶æ€â€

`epoll_create - åˆ›å»ºäº‹ä»¶è¡¨`
```c
int epfd = int epoll_create(int size);
int epoll_create1(int flags);
```
* æœ¬è´¨æ˜¯: æ‰“å¼€ä¸€ä¸ªepollæ–‡ä»¶æè¿°ç¬¦ --> åœ¨å†…æ ¸æ³¨å†Œä¸€ä¸ªepollå¯¹è±¡!
* å†…æ ¸ä¼šç»´æŠ¤: å…³æ³¨çš„fdé›†åˆ, å°±ç»ªäº‹ä»¶é˜Ÿåˆ—
* epfdå°±æ˜¯ä¸€ä¸ªæŒ‡é’ˆ, æŒ‡å‘å†…æ ¸ä¸­æ³¨å†Œçš„epollå¯¹è±¡!

`epoll_ctl - é…ç½®å†…æ ¸é‡Œçš„"äº‹ä»¶å…³ç³»"`
```c
int epoll_ctl(
    int epfd,
    int op,
    int fd,
    struct epoll_event *event
);

op: ä½ è¦å¯¹å…³ç³»åšä»€ä¹ˆ
	EPOLL_CTL_ADD   // å»ºç«‹å…³ç³»  æˆ‘å¼€å§‹å…³å¿ƒè¿™ä¸ªfd
	EPOLL_CTL_MOD   // ä¿®æ”¹å…³ç³»  æˆ‘å…³å¿ƒçš„fdå˜äº†
	EPOLL_CTL_DEL   // åˆ é™¤å…³ç³»  æˆ‘ä¸å…³å¿ƒè¿™ä¸ªfd
fd: è¢«ç›‘å¬ç›®æ ‡çš„fd
	å½“fdçŠ¶æ€å‘ç”Ÿå˜åŒ– --> å†…æ ¸é€šçŸ¥epoll --> epollå°†æ­¤fdæ”¾å…¥readylist
event: ä½ å…³å¿ƒä»€ä¹ˆ + ä½ æƒ³å¸¦å›ä»€ä¹ˆ  poll(event + reevent)
	struct epoll_event {
	    uint32_t events;  // å…³å¿ƒçš„äº‹ä»¶
	    epoll_data_t data; // è¿™æ˜¯â€œå†…æ ¸å¸®ä½ åŸæ ·å¸¦å›çš„ç”¨æˆ·æ•°æ®â€
	};
	
	events: 
		EPOLLIN      // å¯è¯»
		EPOLLOUT     // å¯å†™
		EPOLLERR     // é”™è¯¯
		EPOLLHUP     // æŒ‚æ–­
		EPOLLET      // è¾¹æ²¿è§¦å‘ï¼ˆå…ˆåˆ«æ€¥ï¼‰
	data:
		typedef union epoll_data {
		    void    *ptr;
		    int      fd;
		    uint32_t u32;
		    uint64_t u64;
		} epoll_data_t;
	

```
* epoll_ctl ä¸æ˜¯â€œç›‘å¬ä¸€æ¬¡â€ï¼Œè€Œæ˜¯â€œå»ºç«‹æˆ–ä¿®æ”¹ fd ä¸ epoll(epfd) çš„é•¿æœŸå…³ç³»â€ã€‚


```c
The event argument describes the object linked to the file descriptor fd.  The struct epoll_event is defined as:

           typedef union epoll_data {
               void        *ptr;
               int          fd;
               uint32_t     u32;
               uint64_t     u64;
           } epoll_data_t;

           struct epoll_event {
               uint32_t     events;      /* Epoll events */
               epoll_data_t data;        /* User data variable */
           };
           
events:
       EPOLLIN
              The associated file is available for read(2) operations.

       EPOLLOUT
              The associated file is available for write(2) operations.
```
* epoll_ctl = åœ¨å†…æ ¸ä¸­æ³¨å†Œâ€œå½“ fd å‘ç”Ÿ X äº‹ä»¶æ—¶ï¼Œè¯·é€šçŸ¥æˆ‘ï¼Œå¹¶å¸¦å› Y æ•°æ®â€ã€‚

`epoll_wait - ç­‰"å·²ç»å‘ç”Ÿçš„äº‹ä»¶"`
```c
int epoll_wait(
    int epfd,
    struct epoll_event *events,
    int maxevents,
    int timeout
);

// ç­‰å¾…æˆåŠŸ, è¿”å›å°±ç»ªçš„IOäº‹ä»¶å¯¹åº”çš„fd
```
* å…³æ³¨epfdå¯¹åº”çš„äº‹ä»¶ä¸–ç•Œ, å°†å°±ç»ªäº‹ä»¶æ‹·è´åˆ°ç”¨æˆ·æ€çš„events(å”¯ä¸€ä¸€æ¬¡æ‹·è´æ“ä½œ), æœ€å¤šç­‰å¾…maxeventsä¸ªäº‹ä»¶å°±ç»ª, ç­‰å¾…çš„æ—¶é—´é—´éš”æ˜¯timeout
* epoll_waitç­‰çš„ä¸æ˜¯fd, ç­‰çš„æ˜¯å†…æ ¸ä¸­çš„epollå®ä¾‹çš„readylistæ˜¯å¦éç©º!

`epollä»£ç `
```c++
  1 #include <stdio.h>
  2 #include <unistd.h>
  3 #include <sys/epoll.h>
  4 #include <iostream>
  5 
  6 int main()
  7 {
  8     // 1.å‘å†…æ ¸æ³¨å†Œä¸€ä¸ªepollå®ä¾‹
  9     int epfd = epoll_create1(0);
 10 
 11     struct epoll_event ev; // ç»´æŠ¤çš„äº‹ä»¶è¡¨
 12     ev.events = EPOLLIN; // å…³å¿ƒè¯»äº‹ä»¶
 13     ev.data.fd = 0; // å…³å¿ƒstdin
 14 
 15     epoll_ctl(epfd, EPOLL_CTL_ADD, 0, &ev);
 16 
 17     struct epoll_event events[10]; // å¦‚æœäº‹ä»¶å°±ç»ª --> æ‹·è´åˆ°æ­¤ç”¨æˆ·æ€åˆ›å»ºçš„æ•°ç»„å†…éƒ¨
 18 
 19     while(1)
 20     {
 21         int n = epoll_wait(epfd, events, 10, -1); // è¿”å›å€¼ readylistä¸­å°±ç»ªäº‹ä»¶ä¸ªæ•°
 22 
 23         for(int i = 0; i < n; i++)
 24         {
 25             if(events[i].data.fd == 0)
 26             {
 27                 char buf[128];
 28                 int n = read(0, buf, sizeof(buf));
 29                 buf[n] = '\0';
 30                 std::cout << "(epoll)read: " << buf << std::endl;
 31             }                                                                                                                                        
 32         }
 33     }
 34     return 0;
 35 }
```

epoll_ctl
```
ç”¨æˆ·æ€                              å†…æ ¸æ€
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

epoll_create()
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   epfd(fd)   â”‚ â”€â”€â”€â”€â”€â–¶ â”‚   epoll å¯¹è±¡          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  - ç›‘å¬ fd é›†åˆ       â”‚
                         â”‚  - ready list        â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

epoll_ctl(ADD, fd)
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ socket fd    â”‚ â”€â”€â”€â”€â”€â–¶ â”‚ fd ç­‰å¾…é˜Ÿåˆ—ä¸­               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ + epoll å›è°ƒèŠ‚ç‚¹             â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

epoll_wait
```
            ï¼ˆ1ï¼‰fd çŠ¶æ€å˜åŒ–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   socket fd   â”‚  æ•°æ®åˆ°è¾¾ / å¯¹ç«¯å…³é—­
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           å†…æ ¸             â”‚
â”‚                          â”‚
â”‚  fd ç­‰å¾…é˜Ÿåˆ—è¢«å”¤é†’        â”‚
â”‚        â”‚                 â”‚
â”‚        â–¼                 â”‚
â”‚  epoll å›è°ƒè§¦å‘           â”‚
â”‚        â”‚                 â”‚
â”‚        â–¼                 â”‚
â”‚  äº‹ä»¶åŠ å…¥ ready list     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ï¼ˆ2ï¼‰epoll_wait é˜»å¡åœ¨è¿™é‡Œ
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        epoll_wait         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  - ç­‰ ready list éç©º    â”‚          â”‚
â”‚  - ä¸æ‰«æ fd             â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
         â”‚                            â”‚
         â–¼                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚        ç”¨æˆ·æ€è¿›ç¨‹         â”‚          â”‚
â”‚                          â”‚          â”‚
â”‚ for events[]:            â”‚          â”‚
â”‚   æ ¹æ® data.ptr / fd     â”‚          â”‚
â”‚   read / write (éé˜»å¡)  â”‚          â”‚
â”‚                          â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
                                       â”‚
                while (server_running) â”˜

```

### 4.Reactor(é‡ç‚¹)
å›é¡¾epoll tcp server
```c
  1 // epollé£æ ¼çš„tcp server
  2 struct epoll_event events[10];
  3 while(1)
  4 {
  5     // ç­‰å¾…å†…æ ¸è¿”å›å°±ç»ªäº‹ä»¶
  6     int n = epoll_wait(epfd, events, maxevents, -1);
  7 
  8     // æ‰«æå·²å°±ç»ªçš„äº‹ä»¶
  9     for(int i = 0; i < n; i++)
 10     {
 11         int fd = events[i].data.fd;
 12         if(fd == listen_fd)
 13         {
 14             // æœ‰æ–°çš„å®¢æˆ·ç«¯è¦è¿æ¥
 15             int connection = accept(listen_fd); // å’Œå®¢æˆ·ç«¯å»ºç«‹è¿æ¥
 16             epoll_ctl(epfd, EPOLL_CTL_ADD, connection, &ev); // å»ºç«‹æ–°çš„äº‹ä»¶å…³ç³»(æ›´æ–°äº‹ä»¶è¡¨)
 17         }
 18         else
 19         {
 20             // æœ‰å®¢æˆ·ç«¯è¦å¤„ç†ä¸šåŠ¡(éå»ºç«‹æ–°çš„è¿æ¥)
 21             read(fd, buf, sizeof(buf));
 22             // å¤„ç†ä¸šåŠ¡é€»è¾‘
 23             write(fd, resp, len);                                                                                                                    
 24         }
 25     }
 26 }
```
* **ç‰¹ç‚¹**: IOäº‹ä»¶(accept/read)å’Œä¸šåŠ¡å¤„ç†é€»è¾‘æ··åœ¨ä¸€ä¸ªå¾ªç¯
* é—®é¢˜:
	1. ä¸šåŠ¡å¤„ç†æ—¶é—´è¾ƒé•¿, ä¸‹ä¸€ä¸ªå°±ç»ªçš„äº‹ä»¶æ— æ³•åŠæ—¶å¤„ç†, æ•´ä¸ªå¾ªç¯é˜»å¡
	2. ä»£ç è€¦åˆåº¦é«˜

#### Reactorçš„æ ¸å¿ƒç›®æ ‡
> **äº‹ä»¶åˆ†å‘å’Œä¸šåŠ¡å¤„ç†è§£è€¦ : IOäº‹ä»¶æ£€æµ‹/åˆ†å‘ç‹¬ç«‹äºä¸šåŠ¡å¤„ç†**

* **äº‹ä»¶åˆ†å‘**
	1. ç­‰å¾…epoll_waitäº‹ä»¶å°±ç»ª
	2. æŠŠå°±ç»ªçš„äº‹ä»¶åˆ†å‘ç»™å¯¹åº”çš„handler
* ä¸šåŠ¡å¤„ç†
	1. Handler: å†…éƒ¨å¤„ç†accpept/read/writeç­‰ä¸šåŠ¡é€»è¾‘
	2. Reactorä¸ç®¡ä¸šåŠ¡é€»è¾‘å¤„ç†å¿«æ…¢, åªè´Ÿè´£åˆ†å‘äº‹ä»¶
	
- **Reactor**ï¼š
    - åªç®¡è°ƒåº¦äº‹ä»¶ â†’ éé˜»å¡
- **Handler**ï¼š
    - åªåšè‡ªå·±çš„ä¸šåŠ¡é€»è¾‘
    - Reactor ä¸ç›´æ¥è°ƒç”¨ read/write
    - å¯ä»¥æ”¾åˆ°çº¿ç¨‹æ±  / åç¨‹é‡Œ â†’ å®Œå…¨è§£è€¦

```
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Reactor   â”‚
         â”‚ epoll_wait()â”‚
         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ å°±ç»ªäº‹ä»¶
               â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Dispatcher  â”‚
         â”‚ æ‰¾åˆ° Handler â”‚
         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ è°ƒç”¨
               â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Handler    â”‚
         â”‚  read()/ä¸šåŠ¡ â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

`Reactoré£æ ¼ TCP Serverä»£ç `
```c++
  1 #include <stdio.h>                                                                                                                                   
  2 #include <stdlib.h>
  3 #include <string.h>
  4 #include <unistd.h>
  5 #include <fcntl.h>
  6 #include <errno.h>
  7 #include <netinet/in.h>
  8 #include <sys/epoll.h>
  9 #include <iostream>
 10 
 11 #define PORT 8888
 12 #define MAX_EVENTS 10
 13 #define BUF_SIZE 1024
 14 
 15 // ----- Handler -----
 16 typedef struct Handler{
 17     int fd; // å¤„ç†çš„æ˜¯å“ªä¸€ä¸ªfdçš„äº‹ä»¶
 18     void(*callback)(struct Handler* self); // æ‰§è¡Œå›è°ƒå‡½æ•° -- å¯¹åº”çš„ä¸šåŠ¡å¤„ç†é€»è¾‘
 19 }Handler;
 20 
 21 // ----- å·¥å…·å‡½æ•°(è®¾ç½®éé˜»å¡) -----
 22 void set_nonblock(int fd)
 23 {
 24     int flags = fcntl(fd, F_GETFL, 0);
 25     fcntl(fd, F_SETFL, flags | O_NONBLOCK);
 26 }
 27 
 28 // ----- readä¸šåŠ¡å¤„ç† ------
 29 void read_handler(Handler *h)
 30 {
 31     char buf[1024];
 32     int n = read(h->fd, buf, sizeof(buf));
 33     if(n > 0)
 34     {
 35         buf[n] = '\0';
  36         printf("Client[%d] Say: %s", h->fd, buf);                                                                                                    
 37         write(h->fd, "æœåŠ¡å™¨æˆåŠŸè¯»å–!", sizeof("æœåŠ¡å™¨æˆåŠŸè¯»å–!"));
 38 
 39     }
 40     else if(n == 0 || (n < 0 && errno != EAGAIN))
 41     {
 42         // å¯ä»¥å…³é—­
 43         printf("Client close");
 44         close(h->fd);
 45         h->fd = -1;
 46     }
 47 }
 48 
 49 // ----- acceptä¸šåŠ¡å¤„ç† ------
 50 void accept_handler(Handler* h)
 51 {
 52     int conn_fd = accept(h->fd, NULL, NULL);
 53     set_nonblock(conn_fd);
 54     std::cout << "new client connect!" << conn_fd << std::endl;
 55 
 56     // ç»™æ–°çš„è¿æ¥æ³¨å†Œhandler
 57     Handler* new_h = (Handler*)malloc(sizeof(Handler));
 58     new_h->fd = conn_fd;
 59     new_h->callback = read_handler;
 60 
 61     // æ³¨å†Œåˆ°epoll éœ€è¦æ›´æ–°epollå®ä¾‹  å‘Šè¯‰å†…æ ¸è¿™ä¸ªfdæˆ‘ä¹Ÿè¦ç›‘å¬
 62         // æ³¨å†Œåˆ° epoll
 63     struct epoll_event ev;
 64     ev.events = EPOLLIN | EPOLLET;  // è¾¹æ²¿è§¦å‘
 65     ev.data.ptr = new_h;
 66     extern int epfd;  // å¤–éƒ¨å…¨å±€ epfd
 67     if (epoll_ctl(epfd, EPOLL_CTL_ADD, conn_fd, &ev) < 0) {
 68         perror("epoll_ctl ADD");
 69         close(conn_fd);
 70         free(new_h);
  71     }
 72 }
 73 
 74 // ----- å…¨å±€epfd ------
 75 int epfd;
 76 
 77 // ------ main ------
 78 int main()
 79 {
 80     // åˆ›å»ºç›‘å¬socket
 81     int listen_fd = socket(AF_INET, SOCK_STREAM, 0);
 82     set_nonblock(listen_fd);
 83 
 84     struct sockaddr_in addr;
 85     addr.sin_family = AF_INET;
 86     addr.sin_port = htons(PORT);
 87     addr.sin_addr.s_addr = INADDR_ANY;
 88     bind(listen_fd, (struct sockaddr*)&addr, sizeof(addr));
 89     listen(listen_fd, 128);
 90 
 91     // åˆ›å»ºepollå®ä¾‹
 92     epfd = epoll_create1(0);
 93 
 94     // æ³¨å†Œlisten_fd Handler(æœåŠ¡å™¨çš„listenfd, æœ¬èº«ä¹Ÿè¦è¢«æ³¨å†Œåˆ°epolläº‹ä»¶, è¿™ä¸ªfd, ä¸“é—¨å¤„ç†å®¢æˆ·ç«¯çš„é“¾æ¥)
 95     Handler listen_handler = { listen_fd, accept_handler };
 96     struct epoll_event ev;
 97     ev.events = EPOLLIN;
 98     ev.data.ptr = &listen_handler;
 99     epoll_ctl(epfd, EPOLL_CTL_ADD, listen_fd, &ev);
100 
101     // 4. Reactor å¾ªç¯
102     struct epoll_event events[MAX_EVENTS];
103     while (1) {
104         int n = epoll_wait(epfd, events, MAX_EVENTS, -1);
105         for (int i = 0; i < n; i++) {
106             Handler* h = (Handler*)events[i].data.ptr;
107             if (h->fd != -1)
108                 h->callback(h);  // åˆ†å‘åˆ° Handler
109         }
110     }
111 
112     close(listen_fd);
113     close(epfd);
114     return 0;
115 }
```


```
                          å››ç§ IO æ¨¡å‹æ¼”åŒ–
+-------------------+       æ¼”åŒ–       +-------------------+
|      select       | --------------> |       poll        |
|-------------------|                  |-------------------|
| é˜»å¡/éé˜»å¡å¯é€‰   |                  | é˜»å¡/éé˜»å¡å¯é€‰   |
| ç”¨æˆ·æ€æ‰«æ fd_set  |                  | pollfd æ•°ç»„æ‰«æ   |
| O(N)             |                  | O(N)             |
| fd æ•°é‡æœ‰é™       |                  | æ”¯æŒæ›´å¤š fd       |
+-------------------+                  +-------------------+
        |                                     |
        v                                     v
+-------------------+       æ¼”åŒ–       +-------------------+
|       epoll       | --------------> |      Reactor       |
|-------------------|                  |-------------------|
| éé˜»å¡ä¸ºä¸»        |                  | åŸºäº epoll         |
| å†…æ ¸ç»´æŠ¤å°±ç»ªåˆ—è¡¨  |                  | äº‹ä»¶åˆ†å‘ Dispatcher|
| O(1)             |                  | Handler å›è°ƒ       |
| é«˜å¹¶å‘é€šçŸ¥        |                  | ä¸šåŠ¡å¤„ç†è§£è€¦       |
+-------------------+                  +-------------------+

================================================================================
                            Reactor TCP Server äº¤äº’æµç¨‹
+-------------------+       TCP       +-------------------+
|                   | <------------> |                   |
|    å®¢æˆ·ç«¯ A        |                 |  Reactor TCP Server|
|                   |                |                   |
+-------------------+                +-------------------+
                                          |
                                          |  epoll_wait é˜»å¡ç­‰å¾…äº‹ä»¶
                                          v
                                 +-------------------+
                                 |   Reactor Loop    |
                                 |  (Dispatcher)     |
                                 +-------------------+
                                          |
          +-------------------------------+-------------------------------+
          |                                                               |
          v                                                               v
+-------------------+                                             +-------------------+
|  listen_fd å°±ç»ª    |                                             |  conn_fd å°±ç»ª     |
| (æ–°å®¢æˆ·ç«¯è¿æ¥)     |                                             | (å®¢æˆ·ç«¯å‘æ¶ˆæ¯)    |
+-------------------+                                             +-------------------+
          |                                                               |
          | accept() åˆ›å»º conn_fd                                           | read(fd)
          v                                                               v
+-------------------+                                             +-------------------+
|  æ–°è¿æ¥ Handler    |                                             |  å®¢æˆ·ç«¯ Handler    |
| callback = accept  |                                             | callback = read_handler |
+-------------------+                                             +-------------------+
          |                                                               |
          | epoll_ctl(ADD conn_fd)                                        | ä¸šåŠ¡å¤„ç† + write å›æ˜¾
          v                                                               v
+-------------------+                                             +-------------------+
| Reactor Loop æŒç»­ç›‘æ§ fd |------------------------------------->| å›åˆ° Reactor åˆ†å‘ä¸‹ä¸€ä¸ªäº‹ä»¶ |
+-------------------+                                             +-------------------+

================================================================================
                           Handler å†…éƒ¨é€»è¾‘ç¤ºæ„
+-------------------+       äº‹ä»¶è§¦å‘       +-------------------+
|   Handlerå¯¹è±¡      | -------------->   | ä¸šåŠ¡é€»è¾‘å‡½æ•°       |
|-------------------|                    |-------------------|
| fd = å®¢æˆ·ç«¯ socket |                    | read -> å¤„ç†æ•°æ®   |
| callback = å‡½æ•°æŒ‡é’ˆ |                    | write -> å›æ˜¾     |
+-------------------+                    +-------------------+
          ^                                               ^
          |                                               |
          +-----------------------------------------------+
                         ç”± Reactor è°ƒåº¦è°ƒç”¨

```
- **Reactor Loop**
    - æ°¸è¿œå¾ªç¯ epoll_waitï¼Œä¸é˜»å¡ä¸šåŠ¡å¤„ç†
    - Dispatcher è´Ÿè´£æŠŠå°±ç»ªäº‹ä»¶äº¤ç»™å¯¹åº” Handler
- **Handler**
    - æ¯ä¸ª fd å¯¹åº”ä¸€ä¸ª Handler
    - `accept_handler` â†’ æ–°å®¢æˆ·ç«¯è¿æ¥
    - `read_handler` â†’ è¯»æ¶ˆæ¯ + ä¸šåŠ¡é€»è¾‘ + å›æ˜¾
- **éé˜»å¡ IO**
    - listen_fdã€conn_fd éƒ½æ˜¯éé˜»å¡
    - ä¸šåŠ¡æ…¢æˆ–è¯»ä¸åˆ°æ•°æ®ä¸ä¼šé˜»å¡ Reactor
- **äº‹ä»¶é©±åŠ¨**
    - ä»»ä½•å°±ç»ªäº‹ä»¶éƒ½ä¼šè¢« Reactor åˆ†å‘ï¼Œä¸å½±å“å…¶ä»– fd
    - å¤šå®¢æˆ·ç«¯å¯ä»¥åŒæ—¶äº¤äº’

#### å…¸å‹ä½¿ç”¨æ–¹å¼
- **å•çº¿ç¨‹ Reactor + å¤šçº¿ç¨‹ Handler**
    - Reactor å¾ªç¯åªè´Ÿè´£ epoll_wait + dispatch
    - Handler æäº¤ç»™çº¿ç¨‹æ± å¤„ç†
- **å¼‚æ­¥ä¸šåŠ¡ + å›è°ƒ**
    - Handler å¯ä»¥æ³¨å†Œå®Œæˆäº‹ä»¶çš„å›è°ƒï¼Œç»§ç»­ Reactor å¾ªç¯
- **è¾¹æ²¿è§¦å‘ + éé˜»å¡**
    - Reactor å¾ªç¯æ°¸è¿œéé˜»å¡
    - Handler å†…éƒ¨è‡ªè¡Œå¤„ç†å¯è¯»/å¯å†™é€»è¾‘

# æ€»ç»“
| æ¨¡å‹          | é˜»å¡/éé˜»å¡   | å¤šè·¯å¤ç”¨æœºåˆ¶              | CPU æ‰«ææ–¹å¼       | ä¼˜ç‚¹                           | ç¼ºç‚¹                                        |
| ----------- | -------- | ------------------- | -------------- | ---------------------------- | ----------------------------------------- |
| **select**  | é˜»å¡/éé˜»å¡éƒ½å¯ | fd_set              | æ¯æ¬¡æ‰«æ fd_set    | è·¨å¹³å°ï¼Œç®€å•                       | fd æ•°é‡æœ‰é™ï¼ˆ1024ï¼‰ï¼Œæ¯æ¬¡éƒ½è¦æ‹·è´ fd_setï¼Œæ•ˆç‡ä½ï¼Œæ‰«æå¼€é”€ O(N) |
| **poll**    | é˜»å¡/éé˜»å¡éƒ½å¯ | struct pollfd æ•°ç»„    | æ¯æ¬¡éå†æ•°ç»„         | æ”¯æŒæ›´å¤š fdï¼Œè·¨å¹³å°                  | æ‰«æå¼€é”€ä¾ç„¶ O(N)ï¼Œæ•°ç»„æ¯æ¬¡æ‹·è´                        |
| **epoll**   | éé˜»å¡ä¸ºä¸»    | å†…æ ¸äº‹ä»¶è¡¨ + fd æ³¨å†Œ       | å†…æ ¸ç›´æ¥ç»´æŠ¤å°±ç»ªåˆ—è¡¨     | æ”¯æŒé«˜å¹¶å‘ï¼ŒO(1) äº‹ä»¶é€šçŸ¥ï¼Œä¸éœ€è¦æ¯æ¬¡æ‰«æå…¨é‡ fd | Linux ä¸“ç”¨ï¼Œéœ€è¦éé˜»å¡ + è¾¹æ²¿è§¦å‘æ‰èƒ½é«˜æ•ˆ                 |
| **Reactor** | éé˜»å¡ä¸ºå‰æ   | epoll/kqueue/iocp ç­‰ | åˆ†å‘ç»™ Handler å›è°ƒ | äº‹ä»¶åˆ†å‘ä¸ä¸šåŠ¡å¤„ç†è§£è€¦ï¼Œé«˜å¹¶å‘ï¼Œæ˜“æ‰©å±•          | éœ€è¦è®¾è®¡ Handler ä¸å¾ªç¯é€»è¾‘ï¼Œä»£ç å¤æ‚åº¦é«˜                 |
