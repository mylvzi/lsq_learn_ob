# MP Publisher - 微信公众号发布插件

一个功能强大的 Obsidian 插件，支持自定义样式预览和一键发布到微信公众号。

https://github.com/user-attachments/assets/b62e82a0-9b3c-4406-8007-1bbb6b9b7bac

## ✨ 功能特点

### 📐 样式自定义
- **12+ 预设主题模板**：提供多种精美的公众号样式主题
- **自定义模板**：支持创建和管理自己的样式模板
- **字体选择**：多种中文字体可选
- **字号调整**：灵活调整文章字号
- **背景管理**：支持添加自定义背景图

### 👁️ 实时预览
- **所见即所得**：实时预览公众号效果
- **样式切换**：即时切换不同主题查看效果
- **锁定预览**：可锁定预览状态，专注编辑

### 🚀 一键发布
- **直接发布**：通过微信公众号 API 直接发布草稿
- **图片上传**：自动上传文档中的图片到微信服务器
- **草稿同步**：支持更新已发布的草稿
- **封面选择**：从微信素材库选择或上传封面图
- **元数据管理**：自动管理发布状态和图片信息

### 📋 便捷复制
- **一键复制**：复制格式化后的内容到剪贴板
- **格式保持**：完美保持样式，可直接粘贴到公众号编辑器

## 📦 安装

### 从 Obsidian 社区插件安装（推荐）
1. 打开 Obsidian 设置
2. 进入"第三方插件"
3. 关闭"安全模式"
4. 点击"浏览"并搜索"MP Publisher"
5. 点击安装并启用

### 手动安装
1. 下载最新版本的 `main.js`、`manifest.json` 和 `styles.css`
2. 将文件复制到 `<vault>/.obsidian/plugins/mp-publisher/` 目录
3. 重新加载 Obsidian
4. 在设置中启用插件

## 🎯 使用方法

### 基础使用
1. **打开预览**：点击左侧栏的发送图标，或使用命令"打开公众号发布插件"
2. **选择样式**：在预览窗口顶部选择主题模板、字体和字号
3. **实时预览**：编辑文档时自动更新预览效果
4. **复制内容**：点击"复制到公众号"按钮，然后粘贴到微信公众号编辑器

### 发布到微信公众号
1. **配置 API**：
   - 打开插件设置
   - 填入微信公众号的 AppID 和 AppSecret
   - 设置图片附件存储位置（默认：`[文档名]__assets`）

2. **发布文章**：
   - 点击预览窗口的"发布"按钮，或使用命令"发布到微信公众号"
   - 输入文章标题
   - 选择或上传封面图
   - 点击"发布"按钮

3. **更新文章**：
   - 再次发布同一文档会自动更新已存在的草稿
   - 插件会自动管理文档的发布元数据

### 自定义模板
1. 打开插件设置
2. 找到"模板管理"部分
3. 点击"+ 新建模板"
4. 配置各种样式选项（标题、段落、列表、代码等）
5. 预览效果后保存

### 背景管理
1. 打开插件设置
2. 找到"背景管理"部分
3. 点击"+ 新建背景"
4. 上传或输入背景图 URL
5. 在预览窗口选择背景

## ⚙️ 配置说明

### 微信公众号配置
- **AppID**：公众号的应用ID
- **AppSecret**：公众号的应用密钥
- 获取方式：登录微信公众平台 > 开发 > 基本配置

### 图片存储配置
- **存储位置模式**：
  - `[文档名]__assets`：在文档同级创建资产文件夹
  - `.obsidian/assets`：统一存储在 Obsidian 配置目录
  - 自定义路径：指定任意路径

### 调试模式
- 开启后会在控制台输出详细日志
- 便于排查问题

## 🎨 支持的 Markdown 语法

- ✅ 标题（H1-H6）
- ✅ 段落和换行
- ✅ 粗体、斜体、删除线
- ✅ 有序列表和无序列表
- ✅ 任务列表
- ✅ 引用块
- ✅ 代码块（支持语法高亮）
- ✅ 行内代码
- ✅ 链接
- ✅ 图片
- ✅ 表格
- ✅ 分隔线
- ✅ 脚注

## 📝 元数据管理

插件会在文档的 `[文档名]__assets` 文件夹中创建 `metadata.json` 文件，用于存储：
- 发布的草稿信息（media_id、item）
- 已上传图片的映射关系
- 最后发布时间

## 🔧 常见问题

### Q: 发布时提示"请先配置微信公众号"？
A: 需要在插件设置中填入有效的 AppID 和 AppSecret。

### Q: 图片上传失败？
A: 检查图片格式（支持 jpg/png），大小不超过 2MB，且微信公众号 API 配置正确。

### Q: 如何获取微信公众号的 AppID 和 AppSecret？
A: 登录微信公众平台 > 开发 > 基本配置，可以查看和获取。

### Q: 发布后在哪里查看？
A: 登录微信公众平台 > 素材管理 > 草稿箱，可以看到发布的草稿。

### Q: 样式在公众号编辑器中不正确？
A: 使用"复制到公众号"功能，确保通过剪贴板粘贴到公众号编辑器。

### Q: 发布时提示"IP 白名单错误"（错误码 40164）？
A: 这是由于微信公众平台的 IP 白名单安全机制导致的。解决方法：
   1. 登录[微信公众平台](https://mp.weixin.qq.com/)
   2. 进入「设置与开发」→「基本配置」→「IP 白名单」
   3. 点击「修改」并添加提示中的 IP 地址（如 `127.1xx.1xx.xx`）
   4. 使用管理员微信扫码确认保存
   
   ⚠️ **注意事项**：
   - 如果你的网络使用动态 IP，每次 IP 变化后都需要更新白名单
   - 修改白名单后可能需要等待 5-10 分钟才能生效
   - 你可以通过访问 [whatismyip.com](https://www.whatismyip.com/) 查看当前公网 IP

### Q: 其他使用问题
A: [Quick Start](./QUICKSTART.md)

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📄 许可证

MIT License

## 🙏 致谢

本插件整合了以下优秀项目的功能：
- [mp-preview](https://github.com/Yeban8090/mp-preview): 样式模板预览系统
- [obsidian-enhanced-publisher](https://github.com/chararch/obsidian-enhanced-publisher): 微信发布功能

---

**如果这个插件对你有帮助，欢迎 Star ⭐️**
